<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据比对原型工具</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 自定义颜色类 */
        .bg-match { background-color: #d4edda; } /* 匹配数据 - 浅绿色 */
        .bg-left-only { background-color: #f8d7da; } /* 左表独有 - 浅红色 */
        .bg-right-only { background-color: #d1ecf1; } /* 右表独有 - 浅蓝色 */
        .bg-diff-field { background-color: #fff3cd; } /* 字段值不同 - 浅黄色 */
        .bg-header { background-color: #e2e8f0; } /* 表头背景色 */

        /* 拖放字段样式 */
        .field-item {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.6rem; /* Slightly smaller padding */
            background-color: #e0f2fe; /* light blue */
            border: 1px solid #90cdf4; /* blue-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            cursor: grab;
            user-select: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin: 0.25rem; /* Add margin for spacing */
        }
        .field-item.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        .field-item .remove-btn {
            margin-left: 0.5rem;
            color: #ef4444; /* red-500 */
            cursor: pointer;
            font-weight: bold;
        }

        /* Custom styles for the field lists to match image */
        .field-list-container {
            background-color: #f8fafc; /* bg-gray-50 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* subtle inner shadow */
            min-height: 120px; /* Ensure enough space for fields */
        }

        .selected-keys-dropzone {
            border: 2px dashed #93c5fd; /* blue-300 */
            background-color: #eff6ff; /* blue-50 */
            min-height: 80px;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .selected-keys-dropzone.drag-over {
            border-color: #3b82f6; /* blue-500 */
            background-color: #dbeafe; /* blue-100 */
        }

        /* Tab-like styling for preview tables */
        .tab-header {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            background-color: #e2e8f0; /* bg-gray-200 */
            color: #4a5568; /* text-gray-700 */
            font-weight: 600;
            margin-bottom: -1px; /* Overlap with table border */
            border: 1px solid #cbd5e0; /* border-gray-300 */
            border-bottom: none;
        }
        .tab-header.active {
            background-color: #ffffff;
            border-color: #cbd5e0;
            color: #2d3748; /* text-gray-800 */
        }
    </style>
</head>
<body class="font-sans bg-gray-100 p-0 m-0 w-screen h-screen min-h-screen">
    <div class="w-screen h-screen min-h-screen bg-white shadow-lg rounded-none p-0 m-0 flex flex-col">
        <!-- 表关联配置区域 -->
        <div class="bg-gray-50 p-6 rounded-none shadow-sm mb-8 w-full">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">表关联配置</h1>
                <div class="flex space-x-3">
                    <a href="/query" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">返回数据列表</a>
                    <button id="newComparisonBtn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        + 新建关联
                    </button>
                    <button id="saveComparisonBtn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        保存当前比对
                    </button>
                    <button id="deleteComparisonBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                        删除当前比对
                    </button>
                    <div class="relative">
                        <select id="savedComparisonsSelect" class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg shadow-md leading-tight focus:outline-none focus:bg-white focus:border-gray-500 hover:border-gray-400 transition duration-200">
                            <option value="">选择已保存关联...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据库连接配置区域 -->
            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">数据库连接配置 (模拟)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="dbHost" class="block text-sm font-medium text-gray-700">主机:</label>
                        <input type="text" id="dbHost" value="localhost" class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="dbPort" class="block text-sm font-medium text-gray-700">端口:</label>
                        <input type="text" id="dbPort" value="3306" class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="dbUser" class="block text-sm font-medium text-gray-700">用户:</label>
                        <input type="text" id="dbUser" value="root" class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="dbPassword" class="block text-sm font-medium text-gray-700">密码:</label>
                        <input type="password" id="dbPassword" value="123456" class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="dbName" class="block text-sm font-medium text-gray-700">数据库名:</label>
                        <input type="text" id="dbName" value="jinxiaocun_db" class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                </div>
                <div class="text-center">
                    <button id="connectDbBtn" type="button" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                        连接数据库 (模拟)
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左表配置 -->
                <div class="flex-1 bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-gray-700">左表</h2>
                        <select id="leftTableSelect" class="p-1 border border-gray-300 rounded-md text-sm">
                            <option value="">请先连接数据库...</option>
                        </select>
                    </div>
                    <textarea id="tableAInput" rows="8" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm mb-4" placeholder="数据将从所选表格加载..." readonly></textarea>

                    <h3 class="text-md font-medium text-gray-700 mb-2">左表可用字段:</h3>
                    <div id="availableFieldsA" class="field-list-container flex flex-wrap gap-2 mb-4">
                        <!-- 可拖动字段将插入此处 -->
                    </div>

                    <h3 class="text-md font-medium text-gray-700 mb-2">左表已选关联字段 (拖放至此):</h3>
                    <div id="selectedKeysA" class="selected-keys-dropzone flex flex-wrap gap-2"
                         ondragover="allowDrop(event)" ondrop="handleDrop(event, 'A')"
                         ondragenter="this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')">
                        <!-- 拖放字段将插入此处 -->
                    </div>
                </div>

                <!-- 右表配置 -->
                <div class="flex-1 bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-gray-700">右表</h2>
                        <select id="rightTableSelect" class="p-1 border border-gray-300 rounded-md text-sm">
                            <option value="">请先连接数据库...</option>
                        </select>
                    </div>
                    <textarea id="tableBInput" rows="8" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm mb-4" placeholder="数据将从所选表格加载..." readonly></textarea>

                    <h3 class="text-md font-medium text-gray-700 mb-2">右表可用字段:</h3>
                    <div id="availableFieldsB" class="field-list-container flex flex-wrap gap-2 mb-4">
                        <!-- 可拖动字段将插入此处 -->
                    </div>

                    <h3 class="text-md font-medium text-gray-700 mb-2">右表已选关联字段 (拖放至此):</h3>
                    <div id="selectedKeysB" class="selected-keys-dropzone flex flex-wrap gap-2"
                         ondragover="allowDrop(event)" ondrop="handleDrop(event, 'B')"
                         ondragenter="this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')">
                        <!-- 拖放字段将插入此处 -->
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="applyAssociationBtn" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 text-lg">
                    应用关联
                </button>
            </div>
        </div>

        <!-- 数据预览和比对结果区域 -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">数据展示</h2>

            <!-- 原始数据预览区域 -->
            <div class="flex flex-col lg:flex-row gap-6 mb-8">
                <div class="flex-1 bg-gray-50 rounded-lg shadow-sm overflow-x-auto border border-gray-200">
                    <div class="tab-header active" id="leftPreviewTab">左表预览</div>
                    <div id="tableAPreview" class="w-full text-sm p-4"></div>
                </div>
                <div class="flex-1 bg-gray-50 rounded-lg shadow-sm overflow-x-auto border border-gray-200">
                    <div class="tab-header active" id="rightPreviewTab">右表预览</div>
                    <div id="tableBPreview" class="w-full text-sm p-4"></div>
                </div>
            </div>

            <!-- 比对结果区域 -->
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">比对结果</h2>
                <div id="comparisonResults" class="w-full text-sm">
                    <p class="text-gray-500 text-center py-4">点击“应用关联”按钮查看结果。</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Predefined tables data (used for simulation)
        // const predefinedTables = {
        //     "员工表": {
        //         csv: "ID,Name,Age,City,Position,Salary\n1001,张三,30,北京,经理,15000\n1002,李四,24,上海,开发,12000\n1003,王五,35,广州,测试,10000\n1004,赵六,28,深圳,销售,9000\n1005,钱七,40,北京,总监,25000\n1006,孙八,32,上海,工程师,13000",
        //         defaultKeys: ["ID"]
        //     },
        //     "部门表": {
        //         csv: "DeptID,DeptName,ManagerID,Location\n1,技术部,1001,北京\n2,开发部,1003,上海\n3,设计部,1004,广州\n4,市场部,1005,深圳\n5,财务部,1006,北京",
        //         defaultKeys: ["DeptID"]
        //     },
        //     "项目表": {
        //         csv: "ProjectID,ProjectName,DeptID,StartDate\nP001,新产品开发,1,2023-01-01\nP002,市场推广,4,2023-03-15\nP003,系统升级,2,2023-05-01\nP004,数据分析,1,2023-06-20",
        //         defaultKeys: ["ProjectID", "DeptID"]
        //     }
        // };

        // Global variables for parsed data and selected keys
        let dataA = [];
        let dataB = [];
        let allHeaders = [];
        let currentKeyAFields = [];
        let currentKeyBFields = [];

        // ========== 新增：全局数据库配置缓存 ==========
        let currentDbConfig = null;

        // ========== 替换为真实后端API ===========
        async function fetchDatabaseTables(dbConfig) {
            const response = await fetch('/api/get_tables', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dbConfig)
            });
            const data = await response.json();
            if (response.ok) return data.tables;
            throw new Error(data.error || '获取表失败');
        }

        async function fetchTableData(tableName, dbConfig) {
            const response = await fetch('/api/get_table_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table: tableName, dbconf: dbConfig })
            });
            const data = await response.json();
            if (response.ok) return data.csv_string;
            throw new Error(data.error || '获取表数据失败');
        }

        // ========== 替换模拟函数 ===========
        // mockFetchDatabaseTables → fetchDatabaseTables
        // mockFetchTableData → fetchTableData

        // Helper function: Parse CSV string to array of objects
        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return { headers: [], data: [] };

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue;
                }
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }
            return { headers, data };
        }

        // 左右表预览只显示前5条数据
        function renderTable(data, element) {
            if (!data || data.length === 0) {
                element.innerHTML = '<p class="text-gray-500 text-center py-2">无数据可预览。</p>';
                return;
            }
            const headers = Object.keys(data[0]);
            let tableHtml = '<table class="min-w-full bg-white border border-gray-200 rounded-md overflow-hidden">';
            tableHtml += '<thead><tr class="bg-header">';
            headers.forEach(header => {
                tableHtml += `<th class="py-2 px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${header}</th>`;
            });
            tableHtml += '</tr></thead>';
            tableHtml += '<tbody>';
            data.slice(0, 5).forEach(row => { // 只显示前5条
                tableHtml += '<tr class="hover:bg-gray-50">';
                headers.forEach(header => {
                    tableHtml += `<td class="py-2 px-4 border-b border-gray-200">${row[header] || ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            element.innerHTML = tableHtml;
        }

        // 比对结果分页展示
        let comparePage = 1;
        let comparePerPage = 500;
        let compareResultsCache = [];
        function renderCompareTable(data, element) {
            compareResultsCache = data;
            const total = data.length;
            const totalPages = Math.max(1, Math.ceil(total / comparePerPage));
            comparePage = Math.max(1, Math.min(comparePage, totalPages));
            const startIdx = (comparePage - 1) * comparePerPage;
            const endIdx = Math.min(startIdx + comparePerPage, total);
            if (!data || data.length === 0) {
                element.innerHTML = '<p class="text-gray-500 text-center py-2">无数据可预览。</p>';
                return;
            }
            const headers = Object.keys(data[0]);
            let tableHtml = '<div class="flex items-center gap-4 mb-2">';
            tableHtml += `<span>共 ${total} 条</span>`;
            tableHtml += `<span>每页 <select id='comparePerPageSelect' style='border:1px solid #ccc;border-radius:4px;padding:2px 8px;'>`;
            tableHtml += `<option value='500'${comparePerPage==500?' selected':''}>500</option>`;
            tableHtml += `<option value='1000'${comparePerPage==1000?' selected':''}>1000</option>`;
            tableHtml += `</select></span>`;
            tableHtml += `<span>第 ${comparePage} / ${totalPages} 页</span>`;
            tableHtml += `<button id='comparePrevBtn' ${comparePage==1?'disabled':''} style='padding:2px 8px;border:1px solid #ccc;border-radius:4px;'>上一页</button>`;
            tableHtml += `<button id='compareNextBtn' ${comparePage==totalPages?'disabled':''} style='padding:2px 8px;border:1px solid #ccc;border-radius:4px;'>下一页</button>`;
            tableHtml += '</div>';
            tableHtml += '<table class="min-w-full bg-white border border-gray-200 rounded-md overflow-hidden">';
            tableHtml += '<thead><tr class="bg-header">';
            headers.forEach(header => {
                tableHtml += `<th class="py-2 px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${header}</th>`;
            });
            tableHtml += '</tr></thead>';
            tableHtml += '<tbody>';
            data.slice(startIdx, endIdx).forEach(row => {
                tableHtml += '<tr class="hover:bg-gray-50">';
                headers.forEach(header => {
                    tableHtml += `<td class="py-2 px-4 border-b border-gray-200">${row[header] || ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            element.innerHTML = tableHtml;
            // 事件
            document.getElementById('comparePrevBtn').onclick = function(){ if(comparePage>1){comparePage--; renderCompareTable(compareResultsCache, element);} };
            document.getElementById('compareNextBtn').onclick = function(){ if(comparePage<totalPages){comparePage++; renderCompareTable(compareResultsCache, element);} };
            document.getElementById('comparePerPageSelect').onchange = function(){ comparePerPage=parseInt(this.value); comparePage=1; renderCompareTable(compareResultsCache, element); };
        }

        // Create draggable field element
        function createDraggableField(fieldName) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-item';
            fieldDiv.setAttribute('draggable', 'true');
            fieldDiv.dataset.field = fieldName;
            fieldDiv.textContent = fieldName;

            fieldDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', fieldName);
                e.dataTransfer.effectAllowed = 'move';
                fieldDiv.classList.add('dragging');
            });
            fieldDiv.addEventListener('dragend', (e) => {
                fieldDiv.classList.remove('dragging');
            });
            return fieldDiv;
        }

        // Create selected field element (with remove button)
        function createSelectedField(fieldName, type) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-item bg-blue-200 border-blue-500';
            fieldDiv.dataset.field = fieldName;
            fieldDiv.textContent = fieldName;
            fieldDiv.setAttribute('draggable', 'true'); // 关键：确保可拖动
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'x';
            removeBtn.title = '点击移除';
            removeBtn.addEventListener('click', () => removeSelectedField(fieldName, type));
            fieldDiv.appendChild(removeBtn);
            return fieldDiv;
        }

        // Populate available fields area
        function populateAvailableFields(headers, type) {
            const container = type === 'A' ? document.getElementById('availableFieldsA') : document.getElementById('availableFieldsB');
            if (!container) {
                console.error(`Container for available fields (${type}) not found!`);
                return;
            }
            container.innerHTML = '';
            const currentKeys = type === 'A' ? currentKeyAFields : currentKeyBFields;

            headers.forEach(header => {
                if (!currentKeys.includes(header)) {
                    container.appendChild(createDraggableField(header));
                }
            });
        }

        // Populate selected association fields area
        function populateSelectedKeys(fields, type) {
            const container = type === 'A' ? document.getElementById('selectedKeysA') : document.getElementById('selectedKeysB');
            if (!container) {
                console.error(`Container for selected keys (${type}) not found!`);
                return;
            }
            container.innerHTML = '';
            fields.forEach(field => {
                container.appendChild(createSelectedField(field, type));
            });
        }

        // Allow drag operation
        function allowDrop(event) {
            event.preventDefault();
        }

        // Handle drop operation
        function handleDrop(event, type) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            const fieldName = event.dataTransfer.getData('text/plain');

            const targetKeys = type === 'A' ? currentKeyAFields : currentKeyBFields;
            if (!targetKeys.includes(fieldName)) {
                if (type === 'A') {
                    currentKeyAFields.push(fieldName);
                } else {
                    currentKeyBFields.push(fieldName);
                }
                updateFieldDisplays();
            }
        }
        window.allowDrop = allowDrop;
        window.handleDrop = handleDrop;

        // Remove selected field
        function removeSelectedField(fieldName, type) {
            if (type === 'A') {
                currentKeyAFields = currentKeyAFields.filter(key => key !== fieldName);
            } else {
                currentKeyBFields = currentKeyBFields.filter(key => key !== fieldName);
            }
            updateFieldDisplays();
        }

        // 拖拽排序支持 for selectedKeysA/B
        function enableDragSort(containerId, currentKeys, updateCallback) {
            const container = document.getElementById(containerId);
            let dragIndex = null;
            container.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('field-item')) {
                    dragIndex = Array.from(container.children).indexOf(e.target);
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            container.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('field-item')) {
                    e.target.classList.remove('dragging');
                }
            });
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const dragging = container.querySelector('.dragging');
                const after = getDragAfterElement(container, e.clientX, e.clientY);
                if (after == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, after);
                }
            });
            container.addEventListener('drop', function(e) {
                e.preventDefault();
                const items = Array.from(container.querySelectorAll('.field-item'));
                const newOrder = items.map(item => item.dataset.field);
                currentKeys.length = 0;
                newOrder.forEach(f => currentKeys.push(f));
                if (updateCallback) updateCallback();
            });
        }
        function getDragAfterElement(container, x, y) {
            const items = [...container.querySelectorAll('.field-item:not(.dragging)')];
            return items.find(item => {
                const rect = item.getBoundingClientRect();
                return y < rect.top + rect.height / 2;
            }) || null;
        }
        // 在updateFieldDisplays后调用
        function updateFieldDisplays() {
            const headersA = dataA.length > 0 ? Object.keys(dataA[0]) : [];
            const headersB = dataB.length > 0 ? Object.keys(dataB[0]) : [];
            populateAvailableFields(headersA, 'A');
            populateSelectedKeys(currentKeyAFields, 'A');
            populateAvailableFields(headersB, 'B');
            populateSelectedKeys(currentKeyBFields, 'B');
            // 启用拖拽排序
            enableDragSort('selectedKeysA', currentKeyAFields, null);
            enableDragSort('selectedKeysB', currentKeyBFields, null);
        }

        // 日期格式化函数，转为yyyy/M/d
        function formatDateToYMD(val) {
            if (!val) return '';
            let d = new Date(val.replace(/-/g,'/').replace(/\./g,'/'));
            if (isNaN(d.getTime())) return val;
            return d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate();
        }

        // 修改isMatch函数，针对customer_flow的进货日期和customer_redemption_details的业务日期做格式化后比较
        function isMatch(rowA, rowB, keysA, keysB, tableAName, tableBName) {
            for (let i = 0; i < keysA.length; i++) {
                let valA = rowA[keysA[i]];
                let valB = rowB[keysB[i]];
                // 特殊处理
                if ((tableAName === 'customer_flow' && keysA[i] === '进货日期') || (tableBName === 'customer_flow' && keysB[i] === '进货日期')) {
                    valA = (keysA[i] === '进货日期') ? formatDateToYMD(valA) : valA;
                    valB = (keysB[i] === '进货日期') ? formatDateToYMD(valB) : valB;
                }
                if ((tableAName === 'customer_redemption_details' && keysA[i] === '业务日期') || (tableBName === 'customer_redemption_details' && keysB[i] === '业务日期')) {
                    valA = (keysA[i] === '业务日期') ? formatDateToYMD(valA) : valA;
                    valB = (keysB[i] === '业务日期') ? formatDateToYMD(valB) : valB;
                }
                if (valA !== valB) {
                    return false;
                }
            }
            return true;
        }

        // 新增：后端join比对接口调用
        async function fetchCompareJoin(tableA, tableB, keysA, keysB, dbconf, date_fields) {
            const resp = await fetch('/api/compare_join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tableA, tableB, keysA, keysB, dbconf, date_fields
                })
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error || '后端比对失败');
            if (data.sql) console.log('[后端JOIN SQL]', data.sql);
            return data.csv_string;
        }

        // 修改performComparison，优先用后端join接口
        async function performComparison() {
            const comparisonResults = document.getElementById('comparisonResults');
            if (dataA.length === 0 && dataB.length === 0) {
                comparisonResults.innerHTML = '<p class="text-red-500 text-center py-4">请先加载数据！</p>';
                return;
            }
            const keyAFields = currentKeyAFields;
            const keyBFields = currentKeyBFields;
            if (keyAFields.length === 0 || keyBFields.length === 0) {
                comparisonResults.innerHTML = '<p class="text-red-500 text-center py-4">请拖动字段到“已选关联字段”区域以指定关联字段！</p>';
                return;
            }
            if (keyAFields.length !== keyBFields.length) {
                comparisonResults.innerHTML = '<p class="text-red-500 text-center py-4">表A和表B的关联字段数量必须一致！</p>';
                return;
            }
            // 获取表名
            const tableAName = document.getElementById('leftTableSelect')?.value || '';
            const tableBName = document.getElementById('rightTableSelect')?.value || '';
            // 判断是否需要日期格式化
            let date_fields = {};
            if ((tableAName === 'customer_flow' && keyAFields.includes('进货日期')) && (tableBName === 'customer_redemption_details' && keyBFields.includes('业务日期'))) {
                date_fields = {A: '进货日期', B: '业务日期'};
            } else if ((tableAName === 'customer_redemption_details' && keyAFields.includes('业务日期')) && (tableBName === 'customer_flow' && keyBFields.includes('进货日期'))) {
                date_fields = {A: '业务日期', B: '进货日期'};
            }
            // 优先用后端join
            try {
                comparisonResults.innerHTML = '<p class="text-blue-500 text-center py-4">正在请求后端比对...</p>';
                const csv = await fetchCompareJoin(tableAName, tableBName, keyAFields, keyBFields, currentDbConfig, date_fields);
                // 解析csv并渲染
                const result = parseCSV(csv);
                if (!result.data || result.data.length === 0) {
                    comparisonResults.innerHTML = '<p class="text-red-500 text-center py-4">无匹配数据（后端比对结果为空）。</p>';
                    return;
                }
                renderCompareTable(result.data, comparisonResults);
                return;
            } catch (e) {
                comparisonResults.innerHTML = `<p class='text-red-500 text-center py-4'>后端比对失败：${e.message}，将尝试前端比对...</p>`;
                // 兜底：前端比对
            }
            // 兜底：前端比对
            const missingKeysA = keyAFields.filter(key => dataA.length > 0 && !Object.prototype.hasOwnProperty.call(dataA[0], key));
            const missingKeysB = keyBFields.filter(key => dataB.length > 0 && !Object.prototype.hasOwnProperty.call(dataB[0], key));
            if (missingKeysA.length > 0) {
                comparisonResults.innerHTML = `<p class="text-red-500 text-center py-4">表A中找不到关联字段: "${missingKeysA.join(', ')}"</p>`;
                return;
            }
            if (missingKeysB.length > 0) {
                comparisonResults.innerHTML = `<p class="text-red-500 text-center py-4">表B中找不到关联字段: "${missingKeysB.join(', ')}"</p>`;
                return;
            }
            const results = [];
            const matchedBIndices = new Set();
            dataA.forEach(rowA => {
                let matched = false;
                for (let i = 0; i < dataB.length; i++) {
                    const rowB = dataB[i];
                    if (isMatch(rowA, rowB, keyAFields, keyBFields, tableAName, tableBName)) {
                        matched = true;
                        matchedBIndices.add(i);
                        const combinedRow = { ...rowA };
                        let hasDiff = false;
                        allHeaders.forEach(header => {
                            if (keyAFields.includes(header) || keyBFields.includes(header)) {
                                return;
                            }
                            if (!Object.prototype.hasOwnProperty.call(combinedRow, header)) {
                                combinedRow[header] = rowB[header];
                            } else if (Object.prototype.hasOwnProperty.call(rowB, header) && combinedRow[header] !== rowB[header]) {
                                combinedRow[`${header}_diff`] = true;
                                combinedRow[`${header}_val_A`] = combinedRow[header];
                                combinedRow[`${header}_val_B`] = rowB[header];
                                hasDiff = true;
                            }
                        });
                        matchedResults.push({
                            type: hasDiff ? 'matched_diff' : 'matched',
                            data: combinedRow
                        });
                        break;
                    }
                }
                if (!matched) {
                    leftOnlyResults.push({ type: 'left_only', data: rowA });
                }
            });
            dataB.forEach((rowB, index) => {
                if (!matchedBIndices.has(index)) {
                    rightOnlyResults.push({ type: 'right_only', data: rowB });
                }
            });
            // 只显示匹配上的记录
            const resultsOrdered = [...matchedResults];
            resultsOrdered.sort((a, b) => {
                if (keyAFields.length > 0) {
                    const valA = a.data[keyAFields[0]] || a.data[keyBFields[0]];
                    const valB = b.data[keyAFields[0]] || b.data[keyBFields[0]];
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                }
                return 0;
            });
            renderComparisonResults(resultsOrdered, allHeaders, keyAFields, keyBFields);
        }

        // Event listener: Save current comparison
        function saveCurrentComparison() {
            const name = prompt("请输入保存的比对名称:");
            if (name) {
                const comparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
                comparisons.push({
                    name: name,
                    tableAName: document.getElementById('leftTableSelect').value, // Save table names
                    tableBName: document.getElementById('rightTableSelect').value,
                    keyAFields: currentKeyAFields,
                    keyBFields: currentKeyBFields
                });
                localStorage.setItem('savedComparisons', JSON.stringify(comparisons));
                alert(`比对 "${name}" 已保存！`);
                loadSavedComparisons(); // Reload dropdown after saving
            }
        }

        // Load saved comparisons list to dropdown
        function loadSavedComparisons() {
            const comparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
            const savedComparisonsSelect = document.getElementById('savedComparisonsSelect');
            if (!savedComparisonsSelect) {
                console.error("Saved comparisons select element not found!");
                return;
            }
            savedComparisonsSelect.innerHTML = '<option value="">选择已保存关联...</option>';
            comparisons.forEach((comp, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = comp.name;
                savedComparisonsSelect.appendChild(option);
            });
        }

        // Event listener: Select and load saved comparison
        async function loadSelectedComparison(event) {
            const selectedIndex = event.target.value;
            if (selectedIndex !== "") {
                const comparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
                const selectedComp = comparisons[parseInt(selectedIndex)];
                if (selectedComp) {
                    // Set dropdowns first
                    const leftTableSelect = document.getElementById('leftTableSelect');
                    const rightTableSelect = document.getElementById('rightTableSelect');
                    if (leftTableSelect) leftTableSelect.value = selectedComp.tableAName || '';
                    if (rightTableSelect) rightTableSelect.value = selectedComp.tableBName || '';

                    // Set currentKeyAFields and currentKeyBFields from the loaded comparison FIRST
                    currentKeyAFields = selectedComp.keyAFields || [];
                    currentKeyBFields = selectedComp.keyBFields || [];

                    console.log("Loaded saved fields A (before loadTableData):", currentKeyAFields);
                    console.log("Loaded saved fields B (before loadTableData):", currentKeyBFields);

                    // Load data based on selected table names using mockFetchTableData
                    await loadTableData('A', selectedComp.tableAName);
                    await loadTableData('B', selectedComp.tableBName);

                    console.log("Loaded saved fields A (after loadTableData):", currentKeyAFields);
                    console.log("Loaded saved fields B (after loadTableData):", currentKeyBFields);

                    updateFieldDisplays(); // Ensure available and selected fields are correctly rendered

                    // Perform comparison after everything is set up
                    setTimeout(() => {
                        performComparison();
                    }, 100);
                }
            }
        }

        // Event listener: New comparison
        function newComparison() {
            const tableAInput = document.getElementById('tableAInput');
            const tableBInput = document.getElementById('tableBInput');
            const leftTableSelect = document.getElementById('leftTableSelect');
            const rightTableSelect = document.getElementById('rightTableSelect');
            const leftPreviewTab = document.getElementById('leftPreviewTab');
            const rightPreviewTab = document.getElementById('rightPreviewTab');
            const tableAPreview = document.getElementById('tableAPreview');
            const tableBPreview = document.getElementById('tableBPreview');
            const comparisonResults = document.getElementById('comparisonResults');
            const savedComparisonsSelect = document.getElementById('savedComparisonsSelect');

            if (tableAInput) tableAInput.value = '';
            if (tableBInput) tableBInput.value = '';
            if (leftTableSelect) leftTableSelect.value = ''; // Reset dropdown
            if (rightTableSelect) rightTableSelect.value = ''; // Reset dropdown
            if (leftPreviewTab) leftPreviewTab.textContent = '左表预览'; // Reset tab name
            if (rightPreviewTab) rightPreviewTab.textContent = '右表预览'; // Reset tab name

            dataA = [];
            dataB = [];
            currentKeyAFields = [];
            currentKeyBFields = [];
            allHeaders = [];
            updateFieldDisplays();
            if (tableAPreview) tableAPreview.innerHTML = '<p class="text-gray-500 text-center py-2">无数据可预览。</p>';
            if (tableBPreview) tableBPreview.innerHTML = '<p class="text-gray-500 text-center py-2">无数据可预览。</p>';
            if (comparisonResults) comparisonResults.innerHTML = '<p class="text-gray-500 text-center py-4">点击“应用关联”按钮查看结果。</p>';
            if (savedComparisonsSelect) savedComparisonsSelect.value = "";
        }

        // Function to load table data into input and preview based on table name
        async function loadTableData(type, tableName) {
            const tableInput = type === 'A' ? document.getElementById('tableAInput') : document.getElementById('tableBInput');
            const tablePreview = type === 'A' ? document.getElementById('tableAPreview') : document.getElementById('tableBPreview');
            const tableTab = type === 'A' ? document.getElementById('leftPreviewTab') : document.getElementById('rightPreviewTab');

            if (!tableInput || !tablePreview || !tableTab) {
                console.error(`Missing DOM elements for type ${type} table data loading.`);
                return;
            }

            if (tableName) {
                try {
                    const csvString = await fetchTableData(tableName, currentDbConfig);
                    tableInput.value = csvString;
                    tableTab.textContent = `${tableName} (${type === 'A' ? '左表' : '右表'})`; // Update tab name
                    const result = parseCSV(csvString);
                    if (type === 'A') {
                        dataA = result.data;
                    } else {
                        dataB = result.data;
                    }
                    renderTable(result.data, tablePreview);

                    const headersA = dataA.length > 0 ? Object.keys(dataA[0]) : [];
                    const headersB = dataB.length > 0 ? Object.keys(dataB[0]) : [];
                    allHeaders = Array.from(new Set([...headersA, ...headersB]));

                    updateFieldDisplays(); // Ensure fields are updated after data load
                } catch (error) {
                    console.error(`Error loading data for table ${tableName}:`, error);
                    alert(`加载表格 "${tableName}" 数据失败: ${error.message}`);
                    tableInput.value = '';
                    tableTab.textContent = `${type === 'A' ? '左表' : '右表'}`;
                    if (type === 'A') dataA = []; else dataB = [];
                    renderTable([], tablePreview);
                    updateFieldDisplays();
                }
            } else {
                tableInput.value = '';
                tableTab.textContent = `${type === 'A' ? '左表' : '右表'}`; // Reset tab name
                if (type === 'A') {
                    dataA = [];
                } else {
                    dataB = [];
                }
                renderTable([], tablePreview);
                updateFieldDisplays(); // Clear available fields
            }
        }

        // Populate table select dropdowns
        async function populateTableSelects() {
            const leftTableSelect = document.getElementById('leftTableSelect');
            const rightTableSelect = document.getElementById('rightTableSelect');

            if (!leftTableSelect || !rightTableSelect) {
                console.error("Table select dropdowns not found!");
                return;
            }

            leftTableSelect.innerHTML = '<option value="">选择表格...</option>';
            rightTableSelect.innerHTML = '<option value="">选择表格...</option>';

            try {
                const tables = await fetchDatabaseTables(currentDbConfig); // 传递当前配置
                tables.forEach(tableName => {
                    const optionLeft = document.createElement('option');
                    optionLeft.value = tableName;
                    optionLeft.textContent = tableName;
                    leftTableSelect.appendChild(optionLeft);

                    const optionRight = document.createElement('option');
                    optionRight.value = tableName;
                    optionRight.textContent = tableName;
                    rightTableSelect.appendChild(optionRight);
                });
            } catch (error) {
                console.error("Error fetching table names:", error);
                alert(`获取表格列表失败: ${error.message}`);
            }
        }

        // Function to handle database connection (mocked)
        async function connectToDatabase() {
            const dbConfig = {
                host: document.getElementById('dbHost').value,
                port: document.getElementById('dbPort').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value,
                database: document.getElementById('dbName').value
            };
            currentDbConfig = dbConfig; // 缓存
            console.log("Attempting to connect with config:", dbConfig);

            // Simulate connection success/failure
            try {
                // In a real app, you'd send dbConfig to your backend to establish connection
                await populateTableSelects();
                alert("数据库连接成功！已加载表格列表。");

                // Set default tables after connecting
                const leftTableSelect = document.getElementById('leftTableSelect');
                const rightTableSelect = document.getElementById('rightTableSelect');

                // 不再设置任何默认表名
                // 直接重置选择和数据
                newComparison();

                updateFieldDisplays();
                performComparison();


            } catch (error) {
                console.error("模拟数据库连接失败:", error);
                alert(`模拟数据库连接失败: ${error.message}`);
                newComparison(); // Reset UI on connection failure
            }
        }

        // Function to delete the currently selected comparison
        function deleteCurrentComparison() {
            const savedComparisonsSelect = document.getElementById('savedComparisonsSelect');
            if (!savedComparisonsSelect) {
                console.error("Saved comparisons select element not found for deletion!");
                return;
            }

            const selectedIndex = savedComparisonsSelect.value;
            if (selectedIndex === "" || isNaN(parseInt(selectedIndex))) {
                alert("请先从下拉框中选择一个要删除的比对。");
                return;
            }

            const comparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
            const comparisonName = comparisons[parseInt(selectedIndex)].name;

            // Using prompt for confirmation as alert/confirm are discouraged in some environments
            const confirmation = prompt(`确定要删除比对 "${comparisonName}" 吗？输入 '是' 确认。`);
            if (confirmation && confirmation.toLowerCase() === '是') {
                comparisons.splice(parseInt(selectedIndex), 1); // Remove the selected comparison
                localStorage.setItem('savedComparisons', JSON.stringify(comparisons));
                alert(`比对 "${comparisonName}" 已删除。`);
                loadSavedComparisons(); // Reload the dropdown
                newComparison(); // Reset the UI
            } else {
                alert("删除操作已取消。");
            }
        }


        // Page load initialization
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded fired.");

            // Get DOM elements
            const applyAssociationBtn = document.getElementById('applyAssociationBtn');
            const newComparisonBtn = document.getElementById('newComparisonBtn');
            const saveComparisonBtn = document.getElementById('saveComparisonBtn');
            const deleteComparisonBtn = document.getElementById('deleteComparisonBtn');
            const savedComparisonsSelect = document.getElementById('savedComparisonsSelect');
            const leftTableSelect = document.getElementById('leftTableSelect');
            const rightTableSelect = document.getElementById('rightTableSelect');
            const connectDbBtn = document.getElementById('connectDbBtn'); // New button

            console.log("applyAssociationBtn:", applyAssociationBtn);
            console.log("newComparisonBtn:", newComparisonBtn);
            console.log("saveComparisonBtn:", saveComparisonBtn);
            console.log("deleteComparisonBtn:", deleteComparisonBtn);
            console.log("savedComparisonsSelect:", savedComparisonsSelect);
            console.log("leftTableSelect:", leftTableSelect);
            console.log("rightTableSelect:", rightTableSelect);
            console.log("connectDbBtn:", connectDbBtn);


            // Attach all event listeners
            if (applyAssociationBtn) applyAssociationBtn.addEventListener('click', performComparison);
            else console.error("applyAssociationBtn is null! Cannot attach event listener.");

            if (newComparisonBtn) newComparisonBtn.addEventListener('click', newComparison);
            else console.error("newComparisonBtn is null! Cannot attach event listener.");

            if (saveComparisonBtn) saveComparisonBtn.addEventListener('click', saveCurrentComparison);
            else console.error("saveComparisonBtn is null! Cannot attach event listener.");

            if (deleteComparisonBtn) deleteComparisonBtn.addEventListener('click', deleteCurrentComparison);
            else console.error("deleteComparisonBtn is null! Cannot attach event listener.");

            if (savedComparisonsSelect) savedComparisonsSelect.addEventListener('change', loadSelectedComparison);
            else console.error("savedComparisonsSelect is null! Cannot attach event listener.");

            if (leftTableSelect) leftTableSelect.addEventListener('change', async (event) => {
                await loadTableData('A', event.target.value);
                currentKeyAFields = []; // Clear selected keys when table changes
                updateFieldDisplays();
            });
            else console.error("leftTableSelect is null! Cannot attach event listener.");

            if (rightTableSelect) rightTableSelect.addEventListener('change', async (event) => {
                await loadTableData('B', event.target.value);
                currentKeyBFields = []; // Clear selected keys when table changes
                updateFieldDisplays();
            });
            else console.error("rightTableSelect is null! Cannot attach event listener.");

            // 修正连接按钮事件，阻止页面刷新
            const connectBtn = document.getElementById('connectDbBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // 阻止默认行为，防止刷新
                    connectToDatabase();
                });
            }


            loadSavedComparisons(); // Load saved comparisons list first

            // Automatically connect to the mock DB on load
            await connectToDatabase();
        });
    </script>
</body>
</html>
